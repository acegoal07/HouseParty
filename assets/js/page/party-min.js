window.addEventListener("load",(()=>{const e=new URLSearchParams(window.location.search).get("session_code"),t=document.querySelector("div#loading-icon");e||(window.location.href="/houseparty/join.html");const s=document.querySelector("form#search-song-form"),a=document.querySelector("div#search-results"),o=document.querySelector("span#no-results");let n;function c(){fetch(`assets/php/website/databaseHandler.php?type=checkPartyExistsUser&partyId=${e}`,{method:"GET"}).then((e=>e.json())).then((t=>{if(t.partyExists||(window.location.href="/houseparty/join.html"),0===document.querySelector("div#party-qrcode").childElementCount){const t=`${window.location.origin}/party.html?session_code=`;document.querySelector("span#party-code").textContent=e,document.querySelector("button#copy-party-url").setAttribute("copy-data",`${t}${e}`),document.querySelector("button#share-party-url").setAttribute("share-url",`${t}${e}`),new QRCode(document.querySelector("div#party-qrcode"),{text:`${t}${e}`,width:150,height:150})}t.explicit!==n&&(n=t.explicit,a.hasChildNodes()&&r())})).catch((e=>{}))}function r(){t.classList.remove("hide"),Array.from(a.children).forEach((e=>{"SPAN"!==e.tagName&&a.removeChild(e)}));const n=s.querySelector("input"),c=n.value||a.getAttribute("data-current-search");if(a.setAttribute("data-current-search",c),n.value="",!c||""===c.replaceAll(" ",""))return o.classList.remove("hide"),void t.classList.add("hide");fetch(`assets/php/website/spotifyHandler.php?type=searchSongByName&searchTerm=${c}&partyId=${e}`,{method:"GET"}).then((e=>e.json())).then((s=>{if(1===s.code)return document.dispatchEvent(new CustomEvent("openModal",{detail:{target:"too-many-requests-modal"}}));const n=s.tracks;0!==Object.keys(n).length?o.classList.add("hide"):o.classList.remove("hide");const c=Object.keys(n).slice(0,20);for(const s of c){const o=n[s],c=30;let r=0;const d=[];let l=0;for(let e=0;e<o.artists.length;e++){const t=o.artists[e].name;if(!(r+t.length<=c)){l=o.artists.length-e;break}d.push(t),r+=t.length}let i=d.join(", ");l>0&&(i+=`, and ${l} more`);const u=document.createElement("div");u.className="search-results-item";const h=document.createElement("img");h.src=o.album.images[0].url,h.alt=`${o.name} by ${i} album cover`,h.className="search-results-cover",u.appendChild(h);const p=document.createElement("div");p.className="search-results-info-container";const m=document.createElement("p");if(m.className="search-results-title",m.textContent=o.name,p.appendChild(m),o.explicit){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("xmlns","http://www.w3.org/2000/svg"),e.setAttribute("class","search-results-explicit-icon"),e.setAttribute("viewBox","0 0 16 16");const t=document.createElementNS("http://www.w3.org/2000/svg","path");t.setAttribute("d","M2.5 0A2.5 2.5 0 0 0 0 2.5v11A2.5 2.5 0 0 0 2.5 16h11a2.5 2.5 0 0 0 2.5-2.5v-11A2.5 2.5 0 0 0 13.5 0zm4.326 10.88H10.5V12h-5V4.002h5v1.12H6.826V7.4h3.457v1.073H6.826z"),e.appendChild(t),m.appendChild(e)}const y=document.createElement("p");y.className="search-results-artists",y.textContent=i,p.appendChild(y),u.appendChild(p);const w=document.createElementNS("http://www.w3.org/2000/svg","svg");w.setAttribute("class","search-results-add-song-icon"),w.setAttribute("viewBox","0 0 512 512"),w.setAttribute("xmlns","http://www.w3.org/2000/svg"),w.tabIndex=0,w.setAttribute("aria-label",`Add ${o.name} by ${i} to the queue`),w.setAttribute("role","button");const v=document.createElementNS("http://www.w3.org/2000/svg","path");v.setAttribute("d","M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM232 344l0-64-64 0c-13.3 0-24-10.7-24-24s10.7-24 24-24l64 0 0-64c0-13.3 10.7-24 24-24s24 10.7 24 24l0 64 64 0c13.3 0 24 10.7 24 24s-10.7 24-24 24l-64 0 0 64c0 13.3-10.7 24-24 24s-24-10.7-24-24z"),w.appendChild(v);const g=s=>{"click"!==s.type&&("keydown"!==s.type||"Enter"!==s.key&&" "!==s.key)||(t.classList.remove("hide"),fetch("assets/php/website/spotifyHandler.php",{method:"post",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`type=addSongToQueue&songId=${o.uri}&partyId=${e}`}).then((e=>e.json())).then((e=>{if(t.classList.add("hide"),e.success)switch(e.responseCode){case 1:document.dispatchEvent(new CustomEvent("openModal",{detail:{target:"add-to-queue-successfully-modal",callback:()=>{document.querySelector("#add-queue-successfully-song-name").textContent=`${o.name} by ${i}`}}}));break;case 2:document.dispatchEvent(new CustomEvent("openModal",{detail:{target:"add-to-queue-duplicate-modal",callback:()=>{document.querySelector("#add-queue-duplicate-song-name").textContent=`${o.name} by ${i}`}}}));break;case 3:document.dispatchEvent(new CustomEvent("openModal",{detail:{target:"add-to-queue-not-playing-modal"}}));break;case 4:document.dispatchEvent(new CustomEvent("openModal",{detail:{target:"too-many-requests-modal"}}));break;case 5:document.dispatchEvent(new CustomEvent("openModal",{detail:{target:"add-to-queue-explicit-blocked-modal"}}));break;default:document.dispatchEvent(new CustomEvent("openModal",{detail:{target:"add-to-queue-failed-modal"}}));break}})).catch((e=>{})))};w.addEventListener("keydown",g),w.addEventListener("click",g),u.appendChild(w);const b=document.createElement("a");b.href=o.external_urls.spotify,b.target="_blank",b.rel="noopener noreferrer",b.className="search-results-spotify-logo-link",b.ariaLabel=`Open ${o.title} by ${i} in Spotify`;const f=document.createElement("img");f.src="assets/images/Primary_Logo_White_CMYK.svg",f.alt="Spotify logo",f.className="search-results-spotify-logo",f.href=o.external_urls.spotify,b.appendChild(f),u.appendChild(b),a.appendChild(u)}t.classList.add("hide")})).catch((e=>{}))}c(),setInterval(c,1500),s.addEventListener("submit",(e=>{e.preventDefault(),r()})),t.classList.add("hide")}));